<!doctype html>
<!-- Author email: karakin2000@gmail.com -->

<html lang=ru>
  <head>
    
    <title>Как отправить dmesg через OpenBSD mail</title>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-nwidth, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="../../openbsd.css">
  </head>
  
  <body>
    <h2 id=OpenBSD>
      <a href="../../index.html">
	<i>Open</i><b>BSD</b></a>
      Как отправить dmesg через OpenBSD mail
    </h2>
    <hr>
    <ul>
      <li><a href="#Abstract">Предисловие</a></li>
      <li><a href="#EmailProvider">Настройка почтового ящика</a></li>
      <li><a href="#OpenSMTPD">Найстрока OpenSMTPD</a></li>
      <li><a href="#git-send-email">Отправка письмом коммита из git</a></li>
    </ul>
    <hr>
    <h3 id="Abstract">Предисловие</h3>
    <p>
      Здесь будет описано как настроить штатный SMTP-сервер OpenBSD
      <a href="https://www.opensmtpd.org">OpenSMTPD</a>
      таким образом, чтобы можно было сразу после устновки ОС отправить письмо
      с помощью входящей в базовую систему утилиты mail.
    </p>
    <p>
      Это позволит отправить письмо содержащие вывод команды dmesg по адресу <b>dmesg@openbsd.org</b>,
      а также использовать утилиту
      <a href="https://man.openbsd.org/sendbug">sendbug</a>
      для отправки сообщейний о неполадках.
      А настроив соотвествующим образом git можно будет отправлять письма,
      содержащие изменения исходного кода прямо из этой системы контроля версий.
    </p>
    <p>
      Тем не менее назвать это полноценной найстройкой SMTP-сервера можно едва ли.
      В этой статье OpenSMTPD используется также как и какой-нибудь email-клиент,
      только отправляет письмо по протоколу SMTP на сервер провайдера электронной почты.
      Более сложные конфигурации и скачивание писем с сервера провайдера электронной почты
      в статье не рассмотрены. Не будет также примёров использования с провайдерами электронной почты
      protonmail и tutanota, так как они не позволяют использовать сторонний email-клиент без
      найстройки моста между клиентом и сервером.
    </p>
    <h3 id="EmailProvider">Настройка почтового ящика</h3>
    <p>
      Какой бы провайдер электронной почты вами не был бы выбран,
      вам потребуется открыть веб-интерфейс почтового ящика и в настройках включить использование
      стороннего клиента электронной почты, а затем получить пароль приложения для email-клиента.
    </p>
    
    <details>
      <summary>gmail</summary>
      <p>
	По <a href="https://support.google.com/accounts/answer/185833?hl=ru">инструкции</a>
	      включите возможность
	      использования пароля приложений, создайте и сохраните его у себя,
	      чтобы в дальнейшем при аутентификации OpenSMTPD смог пройти аутентификацию
	с помощью этого пароля приложений.
	Также из <a href="https://support.google.com/mail/answer/7126229">инструкции</a> по настройке почтового клиента нужно запомнить адрес smtp сервера и порт и включить доступ по imap. Хотя в данной статье и затрунуто только взаимодествие по smtp.
	      
      </p>
    </details>

    <details>
      <summary>yandex mail</summary>
      <p>
	Яндекс Справка: <a href="https://yandex.ru/support/mail/mail-clients/others.html#smtpsetting">Настроить только отправку по протоколу SMTP</a>
      </p>
      <p>
	По этой инструкции можно и настроить почтовый ящик, и получить пароль приложения
	и узнать адрес smtp сервера yandex.
	</p>
    </details>
    
    <details>
      <summary>elude.in</summary>
      <p>
	...
      </p>
    </details>
    
    <details>
      <summary>disroot</summary>
      <p>
	...
      </p>
    </details>
    <h3 id="OpenSMTPD">Настройка OpenSMTPD</h3>
    <p>
      Для начала создаём файл, в котором разместим почтовый адрес и полученный пороль приложений.
      Cоздаём так, чтобы права на него были только у почтового сервера.
      Пароль приложения всегда можно заново создать, имея доступ к веб интефейсу провайдер почты,
      однако получение пароля старонним лицом скомпроментирует данный аккаут,
      по этому имеет смысл хранить данный пароль только в этом файле.
    </p>
    <pre class="cmdbox">
touch /etc/mail/secrets
chmod 640 /etc/mail/secrets
chown root:_smtpd /etc/mail/secrets
echo "bob username:password" > /etc/mail/secrets</pre>
    <p>
      Далее настроим сам почтовый сервер отредактировав файл /etc/mail/smtpd.conf
      Вы также могли бы ознакомиться с принципами его найстройки прочтя мануал с соотвествующим названим.
      Я буду постпенно объяснять каждую необходимую строчку конфигурации.
    </p>
    
    <p>
      Здесь включаем файлы с таблицами сопоставления,
      одна из которых содержит наш логин и пароль приложения.    
   </p>

    <pre class="cmdbox">
table aliases file:/etc/mail/aliases
table secrets file:/etc/mail/secrets</pre>

    <p>
      Указываем smtpd на каком сетевом интерфейсе слушать подключения.
      В данном случае на loopback сетевом интерфейсе,
      доступным только изнутри и возвращающем пакеты назад на localhost.
    </p>
    <pre class="cmdbox">
listen on lo0</pre>

    <p>
      В конфиге уже будет указана деректива для отправки писем на локалхост.
      В этих письмах чаще всего оказывается информация от скриптов запускаемых cron.
      Таких как <a href="https://man.openbsd.org/security">security(8)</a> например.
      Здесь также можно выбрать формат храниния, заменив mailbox, на maildir.
      Добавляем дерективу для перенаправлению писем на smtp сервер выбранного почтового провайдера.
    </p>

    <pre class="cmdbox">
action "local_mail" mbox alias &ltalias&gt
action "outbound" relay host smtp+tls://bob@smtp.example.com:587 \
      auth &ltsecrets&gt </pre>

    <p>
      Также в конфиге скорее всего есть деректива соотвествия для доставки письма
      с локалхоста на локалхост.
      Добавляем дерективу, которая укажет соответвие для перенаправления всех отправленных с локалхоста,
      на внешний адресс.
    </p>
    
    <pre class="cmdbox">
match from local for local action "local_mail"
match from local for any action "outbound"</pre>

    <p>
      С этого момента вы можете отправить dmesg используя
      поставляемый с операционный системой почтовый клиент.
      Как это сделать <a href="https://www.openbsd.org/faq/faq4.html#SendDmesg">описано</a> в официальной документации.
      В также можете использовать штатную утилиту для сообщения о неполадках — <a href="https://man.openbsd.org/sendbug">sendbug</a>.
    </p>
 
    <h3 id="git-send-email">Отправка письмом коммита из git</h3>
    <p>
      Устанавливаем необходимые пакеты.
    </p>
    <pre class="cmdbox">
pkg_add git p5-Authen-SASL p5-Net-SMTP-SSL</pre>
    <p>
      В файле конфигурации системы контроля версий git указываем использовать программу,
      которая добавит наш коммит в очередь почтового клиента.
      Расположение этого файла можно узнать из <a href="https://git-scm.com/docs/git-config#FILES">документации</a>.
      </p>
      <pre class="cmdbox">
[sendemail]
    smtpserver = /usr/sbin/sendmail</pre>
<p>
  Теперь вы можете также использовать git send-email.
  Некоторым проектам, вроде ядра Линукс удобнее принимать патчи по электронной почте,
  а не <a href="https://github.com/torvalds/linux/pull/17#issuecomment-5654674">pull request</a>.
  А разработка OpenBSD в принципе подразумевает, что перед получением доступа к системе контроля версий
  CVS вы отправили некоторое количество патчей по почте в соответствующий мейлинлист.
  <a href="https://git-send-email.io/#step-3">Здесь</a> вы можете попробовать этот способ взаимодествия с реальным репозиторием, а <a href="https://git-scm.com/docs/git-send-email">здесь</a> ознакомиться с документацией.
  </p>
    
  </body>
  
  
</html>
